<project default="all">
    <import file="..\IvyServerAntTasks\remote_cluster_build.xml"/>
	<property file="ClusteredServer.properties" />

	<!--
	jmeter manual:
	http://jakarta.apache.org/jmeter/usermanual/component_reference.html
	
	-->
	
	<description>
		Executes performance tests
	</description>
	
	<property name="performance.server" value="zugtstsrv2w0332"/>
	<property name="performance.port" value="80"/>
	
	<property name="performance.ivyscript" value="ivy/pro/performancetest/performance/127755AEEB3C441C/executeIvyScript.ivp"/>
	<property name="performance.dbquery" value="ivy/pro/performancetest/performance/127755AEEB3C441C/executeSqlQuery.ivp"/>
	<property name="performance.onetask" value="ivy/pro/performancetest/performance/127755AEEB3C441C/createOneTask.ivp"/>
	
	<!-- Define an environment variable pointing to JMETER folder or change this -->
	<property environment="env"/>
	<!--property name="jmeter-home" location="${env.JMETER_DIR}"/-->
	<property name="jmeter-home" location="lib/jmeter/"/>

	<!-- ant-jmeter.jar comes with jmeter, be sure this is the release you have -->
	<path id="ant.jmeter.classpath">
		<pathelement
       location="${jmeter-home}/extras/ant-jmeter-1.0.9.jar" />
	</path>

	<taskdef 
	    name="jmeter"
	    classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask"
	    classpathref="ant.jmeter.classpath" />

	<target name="all" depends="executeAllTestsOnAllConfiguration, report"/>
	
	<target name="clean">
		<delete dir="results"/>
		<delete file="jmeter.log"/>
		<mkdir dir="results/jtl"/>
		<mkdir dir="results/html"/>
	</target>
	
	<target name="executeAllTestsOnAllConfiguration" depends="clean">
	  
	  <antcall target="install-and-run-remote-cluster"/>	  

	<!--	  <antcall target="executeAllTests">
		<param name="execute.nodes" values="4"/>
	  </antcall>
	  
	  <antcall target="remote-server-stop">
	    <param name="remote.host" value="${performance.node4.host}"/>
		<param name="instance.id" value="${performance.instance.id}"/>
	  </antcall>
	
	  <antcall target="remote-server-stop">
	    <param name="remote.host" value="${performance.node3.host}"/>
		<param name="instance.id" value="${performance.instance.id}"/>
	  </antcall>-->

	  <antcall target="executeAllTests">
		<param name="execute.nodes" value="2"/>
	  </antcall>

	  <antcall target="remote-server-stop">
	    <param name="remote.host" value="${node2.remote.host}"/>
		<param name="instance.id" value="${node2.instance.id}"/>
	  </antcall>

	  <antcall target="executeAllTests">
		<param name="execute.nodes" value="1"/>
	  </antcall>
	  
	  <!-- uninstall all cluster nodes -->
	  <antcall target="uninstall-remote-cluster"/>
    </target>
	
	<!--
		Executes the full test 
	-->
	<target name="executeAllTests">
		<antcall target="executeTests">
			<param name="execute.name" value="ivyScript"/>
			<param name="execute.page" value="${performance.ivyscript}"/>
			<param name="execute.nodes" value="2"/>
			<param name="execute.1.loops" value="5000"/>
			<param name="execute.5.loops" value="1000"/>
			<param name="execute.10.loops" value="500"/>
			<param name="execute.15.loops" value="330"/>
			<param name="execute.20.loops" value="250"/>
			<param name="execute.30.loops" value="160"/>
			<param name="execute.50.loops" value="100"/>
			<param name="execute.100.loops" value="50"/>				
		</antcall>
		<antcall target="executeTests">
			<param name="execute.name" value="dbQuery"/>
			<param name="execute.page" value="${performance.dbquery}"/>
			<param name="execute.nodes" value="2"/>
		</antcall>
		<antcall target="executeTests">
			<param name="execute.name" value="oneTask"/>
			<param name="execute.page" value="${performance.onetask}"/>
			<param name="execute.nodes" value="2"/>
			<param name="execute.1.loops" value="500"/>
			<param name="execute.5.loops" value="100"/>
			<param name="execute.10.loops" value="50"/>
			<param name="execute.15.loops" value="33"/>
			<param name="execute.20.loops" value="25"/>
			<param name="execute.30.loops" value="16"/>
			<param name="execute.50.loops" value="10"/>
			<param name="execute.100.loops" value="5"/>				
		</antcall>
	</target>
	
	<!--
	Executes a test 1000 times with 1, 5, 10, 15, 20, 30, 50, 100 users
	Required parameter:
		execute.name
		exeucte.page	
	-->
	<target name="executeTests">
		<property name="execute.1.loops" value="2000"/>
	    <property name="execute.5.loops" value="400"/>
	    <property name="execute.10.loops" value="200"/>
	    <property name="execute.15.loops" value="132"/>
	    <property name="execute.20.loops" value="100"/>
        <property name="execute.30.loops" value="66"/>
 	    <property name="execute.50.loops" value="40"/>
		<property name="execute.100.loops" value="20"/>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.1.loops}"/>
			<param name="singleRequest.threads" value="1"/>
		</antcall>
	
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.5.loops}"/>
			<param name="singleRequest.threads" value="5"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.10.loops}"/>
			<param name="singleRequest.threads" value="10"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.15.loops}"/>
			<param name="singleRequest.threads" value="15"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.20.loops}"/>
			<param name="singleRequest.threads" value="20"/>
		</antcall>
		
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.30.loops}"/>
			<param name="singleRequest.threads" value="30"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.50.loops}"/>
			<param name="singleRequest.threads" value="50"/>
		</antcall>
		
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.loops" value="${execute.100.loops}"/>
			<param name="singleRequest.threads" value="100"/>
		</antcall>
	</target>
	
	<!-- 
		Required parameter:
		- singleRequest.name
		- singleRequest.page
		- singleRequest.loops
		- singleRequest.threads
	-->
	<target name="singleRequest">
		<jmeter 
			jmeterhome="${jmeter-home}" 
			testplan="jmetertest/singleRequest.jmx"
			resultlog="results/jtl/singleRequest_${singleRequest.name}_${singleRequest.loops}-loops_${singleRequest.threads}-users_${execute.nodes}-nodes.jtl">
			
			<property name="runner.name" value="${singleRequest.name}"/>
			<property name="runner.server" value="${performance.server}"/>
			<property name="runner.port" value="${performance.port}}"/>
			<property name="runner.page" value="${singleRequest.page}"/>
			<property name="runner.loops" value="${singleRequest.loops}"/>
			<property name="runner.threads" value="${singleRequest.threads}"/>

		</jmeter>		
	</target>

	<target name="report">
		<xslt
       basedir="results/jtl"
       destdir="results/html"
       includes="*.jtl"
       style="${jmeter-home}/extras/jmeter-results-detail-report_21.xsl"/>
	</target>

</project>