<project default="all">
    <import file="..\IvyServerAntTasks\build_ivy\remote\remote_cluster_build.xml"/>
	<property file="ClusteredServer.properties" />
	<taskdef resource="net/sf/antcontrib/antlib.xml" />

	<!--
	jmeter manual:
	http://jakarta.apache.org/jmeter/usermanual/component_reference.html
	
	-->
	
	<description>
		Executes performance tests
	</description>
	
	<property name="performance.server" value="zugtstsrv2w0332"/>
	<property name="performance.port" value="80"/>
	<property name="execute.duration" value="60"/>

	<property name="performance.ivyscript" value="ivy/pro/System/TestCasesPerformance/127755AEEB3C441C/executeIvyScript.ivp"/>
	<property name="performance.dbquery" value="ivy/pro/System/TestCasesPerformance/127755AEEB3C441C/executeSqlQuery.ivp"/>
	<property name="performance.onetask" value="ivy/pro/System/TestCasesPerformance/127755AEEB3C441C/createOneTask.ivp"/>
	
	<!-- Define an environment variable pointing to JMETER folder or change this -->
	<property environment="env"/>
	<!--property name="jmeter-home" location="${env.JMETER_DIR}"/-->
	<property name="jmeter-home" location="lib/jmeter/"/>

	<!-- ant-jmeter.jar comes with jmeter, be sure this is the release you have -->
	<path id="ant.jmeter.classpath">
		<pathelement
       location="${jmeter-home}/extras/ant-jmeter-1.0.9.jar" />
	</path>

	<taskdef 
	    name="jmeter"
	    classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask"
	    classpathref="ant.jmeter.classpath" />

	<target name="all" depends="executeAllTestsOnAllConfiguration, report"/>
	
	<target name="clean">
		<delete dir="results"/>
		<delete file="jmeter.log"/>
		<mkdir dir="results/jtl"/>
		<mkdir dir="results/html"/>
	</target>
	
	<target name="executeAllTestsOnAllConfiguration" depends="clean">
	  
	  <trycatch>
		  <try>
			<antcall target="install-and-run-remote-cluster"/>	  

<!--			  <antcall target="executeAllTests">
				<param name="execute.nodes" value="4"/>
				<param name="execute.duration" value="${execute.duration}"/>
			  </antcall>-->
			  
<!--			  <antcall target="remote-server-stop">
				<param name="remote.host" value="${node4.remote.host}"/>
				<param name="instance.id" value="${node4.instance.id}"/>
			  </antcall>
			
			  <antcall target="remote-server-stop">
				<param name="remote.host" value="${node3.remote.host}"/>
				<param name="instance.id" value="${node3.instance.id}"/>
			  </antcall>-->

			  <antcall target="executeAllTests">
				<param name="execute.nodes" value="2"/>
				<param name="execute.duration" value="${execute.duration}"/>
			  </antcall>

			  <antcall target="remote-server-stop">
				<param name="remote.host" value="${node2.remote.host}"/>
				<param name="instance.id" value="${node2.instance.id}"/>
			  </antcall>

<!--			  <antcall target="executeAllTests">
				<param name="execute.nodes" value="1"/>
				<param name="execute.duration" value="${execute.duration}"/>				
			  </antcall>-->
		  </try>
		  <finally>  
			<!-- uninstall all cluster nodes -->
			<antcall target="uninstall-remote-cluster"/>
		  </finally>
		</trycatch>
    </target>
	
	<!--
		Executes the full test 
	-->
	<target name="executeAllTests">
<!--		<antcall target="executeTests">
			<param name="execute.name" value="ivyScript"/>
			<param name="execute.page" value="${performance.ivyscript}"/>
			<param name="execute.nodes" value="${execute.nodes}"/>
			<param name="execute.duration" value="${execute.duration}"/>
		</antcall>-->
		<antcall target="executeTests">
			<param name="execute.name" value="dbQuery"/>
			<param name="execute.page" value="${performance.dbquery}"/>
			<param name="execute.nodes" value="${execute.nodes}"/>
			<param name="execute.duration" value="${execute.duration}"/>
		</antcall>
		<antcall target="executeTests">
			<param name="execute.name" value="oneTask"/>
			<param name="execute.page" value="${performance.onetask}"/>
			<param name="execute.nodes" value="${execute.nodes}"/>
			<param name="execute.duration" value="${execute.duration}"/>
		</antcall>
	</target>
	
	<!--
	Executes a test for 1 minute with 1, 5, 10, 15, 20, 30, 50, 100 users
	Required parameter:
		execute.name
		exeucte.page	
	-->
	<target name="executeTests">
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="1"/>
		</antcall>
	
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="5"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="10"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="15"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="20"/>
		</antcall>
		
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="30"/>
		</antcall>

		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="50"/>
		</antcall>
		
		<antcall target="singleRequest">
			<param name="singleRequest.name" value="${execute.name}"/>
			<param name="singleRequest.page" value="${execute.page}"/>
			<param name="singleRequest.duration" value="${execute.duration}"/>
			<param name="singleRequest.threads" value="100"/>
		</antcall>
	</target>
	
	<!-- 
		Required parameter:
		- singleRequest.name
		- singleRequest.page
		- singleRequest.loops
		- singleRequest.threads
	-->
	<target name="singleRequest">
		<jmeter 
			jmeterhome="${jmeter-home}" 
			testplan="jmetertest/singleRequest.jmx"
			resultlog="results/jtl/singleRequest_${singleRequest.name}_${singleRequest.duration}-duration_${singleRequest.threads}-users_${execute.nodes}-nodes.jtl">
			
			<property name="runner.name" value="${singleRequest.name}"/>
			<property name="runner.server" value="${performance.server}"/>
			<property name="runner.port" value="${performance.port}}"/>
			<property name="runner.page" value="${singleRequest.page}"/>
			<property name="runner.duration" value="${singleRequest.duration}"/>
			<property name="runner.threads" value="${singleRequest.threads}"/>

		</jmeter>		
	</target>

	<target name="report">
		<xslt
       basedir="results/jtl"
       destdir="results/html"
       includes="*.jtl"
       style="${jmeter-home}/extras/jmeter-results-detail-report_21.xsl"/>
	</target>

</project>