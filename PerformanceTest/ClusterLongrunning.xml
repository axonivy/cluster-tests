<project default="all">

	<description>
    Executes a long running test
  </description>

	<path id="classpath.antcontrib">
		<fileset dir="../antlibs" includes="**/*.jar"/>
	</path>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="classpath.antcontrib"/>

	<!-- Execution parameters, overridden by the jenkins job -->
	<property name="src.job.name" value="Trunk_All" />
	<property name="src.build.number" value="lastSuccessfulBuild" />
	<property name="execute.threads" value="16" />
	<property name="execute.duration" value="10800"/>

	<!-- defines the used nodes (they have to be configured in ClusterLongrunning.properties) -->
	<property name="execute.nodes" value="2"/>
	<property name="execute.node.names" value="node1,node2"/>
	<property name="execute.name" value="ClusterTest_LongRunning"/>

	<!-- remote cluster -->
	<property file="ClusterLongrunning.properties" />
	<import file="..\IvyServerAntTasks\build_ivy\remote\remote_cluster_build.xml"/>

	<!--
  jmeter manual:
  http://jakarta.apache.org/jmeter/usermanual/component_reference.html
  -->

	<property name="jmeter-home" location="lib/jmeter/"/>

	<!-- ant-jmeter.jar comes with jmeter, be sure this is the release you have -->
	<path id="ant.jmeter.classpath">
		<pathelement
       location="${jmeter-home}/extras/ant-jmeter-1.0.9.jar" />
	</path>

	<taskdef 
      name="jmeter"
      classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask"
      classpathref="ant.jmeter.classpath" />

	<target name="all" depends="executeAllTests"/>

	<target name="clean">
		<parallel>
			<!-- Be sure local server is uninstalled -->
			<trycatch>
				<try>
					<antcall target="server-uninstall"/>
				</try>
				<catch>
					<echo>Uninstall local server failed (can be ignored, was not installed before)</echo>
				</catch>
			</trycatch>
			<!-- Be sure remote cluster is uninstalled -->
			<trycatch>
				<try>
					<antcall target="uninstall-remote-cluster"/>
				</try>
				<catch>
					<echo>Uninstall remote cluster failed (can be ignored, was not installed before)</echo>
				</catch>
			</trycatch>
		</parallel>

		<delete dir="results"/>
		<delete file="jmeter.log"/>
		<mkdir dir="results/jtl"/>
		<mkdir dir="results/html"/>
		<mkdir dir="results/logs"/>
	</target>

	<target name="executeAllTests" depends="clean">
		<trycatch>
			<try>
				<antcall target="install-and-run-remote-cluster"/>
				<antcall target="stop-remote-cluster" />
				<antcall target="startClusterExecuteTestsAndStopCluster"/>
			</try>
			<finally>
				<!-- ensure all cluster nodes are stopped -->
				<antcall target="stop-remote-cluster" />
			</finally>
		</trycatch>
	</target>

	<!--
    starts remote cluster, executes all tasks and stops remote clusters
  -->
	<target name="startClusterExecuteTestsAndStopCluster">
		<for parallel="false" list="${execute.node.names}" param="node.name">
			<sequential>
				<antcall target="remote-server-start">
					<param name="remote.host" value="${@{node.name}.remote.host}" />
					<param name="instance.id" value="${@{node.name}.instance.id}" />
				</antcall>
			</sequential>
		</for>
		<echo>Running Test Cases</echo>
		<parallel>
			<antcall target="multiRequest"/>
		</parallel>
		<echo>Test Cases Finished</echo>
		<for parallel="true" list="${execute.node.names}" param="node.name">
			<sequential>
				<antcall target="remote-server-stop">
					<param name="remote.host" value="${@{node.name}.remote.host}"/>
					<param name="instance.id" value="${@{node.name}.instance.id}"/>
				</antcall>
			</sequential>
		</for>
	</target>

	<!--
	  Starts JMeter which performs parallel calls for each test case (ivyscript, dbquery, new task)
	-->
	<target name="multiRequest">

		<!-- store jkmanager status -->
		<get src="http://${performance.server}/jkmanager/" dest="results/logs/jkmanager_status_${execute.name}-multiRequest_${execute.duration}-duration_${execute.threads}-users_${execute.nodes}-nodes_before.html" ignoreerrors="true"/>
		<!-- store ivy cluster status -->
		<get src="http://${performance.server}/ivy/info/index.jsp?pageId=cluster_panel" dest="results/logs/cluster_status_${execute.name}-multiRequest_${execute.duration}-duration_${execute.threads}-users_${execute.nodes}-nodes_before.html" ignoreerrors="true"/>

		<jmeter 
      jmeterhome="${jmeter-home}" 
      testplan="jmetertest/multiRequest.jmx"
      resultlog="results/jtl/execute_${execute.name}_${execute.duration}-duration_${execute.threads}-users_${execute.nodes}-nodes.jtl">

			<property name="runner.name" value="${execute.name}"/>
			<property name="runner.server" value="${performance.server}"/>
			<property name="runner.port" value="${performance.port}"/>
			<property name="runner.duration" value="${execute.duration}"/>
			<property name="runner.threads" value="${execute.threads}"/>
		</jmeter>

		<!-- store jkmanager status -->
		<get src="http://${performance.server}/jkmanager/" dest="results/logs/jkmanager_status_${execute.name}-multiRequest_${execute.duration}-duration_${execute.threads}-users_${execute.nodes}-nodes_after.html" ignoreerrors="true"/>
		<!-- store ivy cluster status -->
		<get src="http://${performance.server}/ivy/info/index.jsp?pageId=cluster_panel" dest="results/logs/cluster_status_${execute.name}-multiRequest_${execute.duration}-duration_${execute.threads}-users_${execute.nodes}-nodes_after.html" ignoreerrors="true"/>

	</target>

</project>