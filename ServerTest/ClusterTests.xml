<project default="all">

	<property name="template.dir" value="installation_template"/>
	<property name="dir.ivy.server.ant.tasks" value="..\..\builtUtil\IvyServerAntTasks"/>
	<property name="dir.antlibs" value="c:\dev\EnvArchive\antlibs"/>

    <import file="${dir.ivy.server.ant.tasks}\build_ivy\local\local_cluster_build.xml"/>
	<property file="ClusteredServer.properties" />
	
	<path id="classpath.antcontrib">
	  <fileset dir="${dir.antlibs}" includes="**/*.jar"/>
	</path>
	
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="classpath.antcontrib"/>
	
	<description>
		Executes cluster akceptance tests
	</description>
		
	<target name="installAndStartCluster">
		<antcall target="install-and-run-local-cluster"/>	 
    <!--<antcall target="install-and-run-server-standalone"/> -->
	</target>

	<target name="stopAndUninstallCluster">
		<antcall target="uninstall-local-cluster"/>
    <!--<antcall target="server-uninstall"/>-->
	</target>

	<target name="all" depends="executeTaskResume"/>
	
	<target name="clean">
	</target>
	
	<target name="test">
	    <mkdir dir="UnitTests"/>
		<junit printsummary="yes" fork="yes" timeout="1200000" maxmemory="512m" dir="${basedir}">
			<classpath>
    			<pathelement path="classes"/>
    			<fileset dir="${basedir}">
      				<include name="lib/*.jar"/>
    			</fileset>
            </classpath>
			<jvmarg value="-ea" />
			<batchtest todir="UnitTests">
				<formatter type="xml" />
				<fileset dir="src">
					<include name="**/Test*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	<target name="executeTaskResume" depends="clean">
	  
	  <trycatch>
		  <try>
			<antcall target="installAndStartCluster"/>	  
     		<antcall target="test"/>
		  </try>
		  <finally>  
			<!-- uninstall all cluster nodes -->
			<antcall target="stopAndUninstallCluster"/>
		  </finally>
		</trycatch>
    </target>
</project>