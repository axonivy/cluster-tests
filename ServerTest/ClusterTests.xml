<project default="all">

	<property name="template.dir" value="installation_template"/>
	<property name="dir.ivy.server.ant.tasks" value="..\..\builtUtil\IvyServerAntTasks"/>
	<property name="dir.antlibs" value="c:\dev\EnvArchive\antlibs"/>

	<property file="ClusteredServer.properties" />

	<import file="${dir.ivy.server.ant.tasks}\build_ivy\remote\remote_cluster_build.xml"/>
	
	<property name="node1.baseUri" value="http://${node1.remote.host}:${node1.http.port}"/>
    <property name="node2.baseUri" value="http://${node2.remote.host}:${node2.http.port}"/>

	<path id="classpath.antcontrib">
	  <fileset dir="${dir.antlibs}" includes="**/*.jar"/>
	</path>
	
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="classpath.antcontrib"/>
	
	<description>
		Executes cluster aceptance tests
	</description>

	<target name="all" depends="executeTasks"/>

  <target name="executeTasks" depends="clean">
  	
    <!-- Be sure cluster is uninstalled -->
    <trycatch>
      <try>
         <antcall target="uninstall-remote-cluster"/>
      </try>
      <catch>
      <echo>Uninstall cluster failed (can be ignored)</echo>
      </catch>
    </trycatch>
    <trycatch>
      <try>
        <!-- Install cluster with two nodes -->
      	<antcall target="install-and-run-remote-cluster"/>
      	
      	<!-- Executes all JUnit tests (/src/**/Test*.java) -->
      	<antcall target="executeJUnitTest">
      		<param name="JavaClassNamePattern" value="Test*.java" />
      	</antcall>
      	
      	<!-- Tests the event-bean tests (ant and junit) -->
      	<antcall target="testEventBeans"/>
      </try>
      <finally>  
        <!-- stop cluster nodes (do not uninstall, maybe we need the log-result in case of an error) -->
        <antcall target="stop-remote-cluster"/>
      </finally>
    </trycatch>
  </target>

  <target name="clean">
  </target>
	
  <target name="testEventBeans" description="Test start/stop behavior of 'start event bean' and the 'intermediate event bean'">
    <antcall target="clearEventBeanLogs" />
    
    <!-- Start and stop Cluster node in defined sequence -->
    <!-- ** node 1 must be still the master -->
    <antcall target="stop-start-server-node2" />
    
    <!-- ** node 2 must be the master -->
    <antcall target="stop-start-server-node1" />

    <!-- ** node 2 must STILL be the master -->
    <antcall target="stop-start-server-node1" />

    <!-- ** node 1 must be the master -->
    <antcall target="stop-start-server-node2" />
    
    <!-- assert start and stop of event beans -->
    <copy todir="classes">
      <fileset dir="src" includes="**/*.log"/>
    </copy>
    <antcall target="executeJUnitTest">
      <param name="JavaClassNamePattern" value="AssertEventBeanLog.java" />
    </antcall>
  </target>
  
  <target name="clearEventBeanLogs">
  	<echo>sleeping first</echo>
  	<sleep seconds="60 "/>
  	<echo>starting now</echo>
  	
    <!-- cleans the event bean log on each node and each bean (an error will be thrown, but the file is cleared) -->
	<property name="node1.clearLogUri" value="${node1.baseUri}/ivy/pro/System/TestCasesPerformance/12D992D7A5DD33E0/clearEventBeanLog.ivp"/>
	<property name="node2.clearLogUri" value="${node2.baseUri}/ivy/pro/System/TestCasesPerformance/12D992D7A5DD33E0/clearEventBeanLog.ivp"/>
    <get src="${node1.clearLogUri}?beanName=ClusterIntermediateEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node1.clearLogUri}?beanName=ClusterStartEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node1.clearLogUri}?beanName=MasterIntermediateEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node1.clearLogUri}?beanName=MasterStartEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node2.clearLogUri}?beanName=ClusterIntermediateEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node2.clearLogUri}?beanName=ClusterStartEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node2.clearLogUri}?beanName=MasterIntermediateEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
    <get src="${node2.clearLogUri}?beanName=MasterStartEventBean" dest="${java.io.tmpdir}/clear1" ignoreerrors="true" retries="0"/>
  </target>
  
  <target name="stop-start-server-node1">
  	<echo>sleeping first</echo>
  	<sleep seconds="60 "/>
  	<echo>starting now</echo>
  	
    <antcall target="remote-server-stop">
       <param name="remote.host" value="${node1.remote.host}" />
       <param name="instance.id" value="${node1.instance.id}" />
    </antcall>
    <antcall target="remote-server-start">
       <param name="remote.host" value="${node1.remote.host}" />
       <param name="instance.id" value="${node1.instance.id}" />
    </antcall>
  </target>

  <target name="stop-start-server-node2">
  	<echo>sleeping first</echo>
  	<sleep seconds="60 "/>
  	<echo>starting now</echo>
  	
    <antcall target="remote-server-stop">
       <param name="remote.host" value="${node2.remote.host}" />
       <param name="instance.id" value="${node2.instance.id}" />
    </antcall>
    <antcall target="remote-server-start">
       <param name="remote.host" value="${node2.remote.host}" />
       <param name="instance.id" value="${node2.instance.id}" />
    </antcall>
  </target>
  
  <target name="executeJUnitTest">
  	  <echo>sleeping first</echo>
  	  <sleep seconds="60 "/>
  	  <echo>starting now</echo>
  	
      <mkdir dir="UnitTests"/>
      <junit printsummary="yes" fork="yes" timeout="1200000" maxmemory="512m" dir="${basedir}">
      <classpath>
          <pathelement path="classes"/>
          <fileset dir="${basedir}">
              <include name="lib/*.jar"/>
          </fileset>
      </classpath>
      <jvmarg value="-ea" />

      <sysproperty key="node1.baseUri" value="${node1.baseUri}"/>
      <sysproperty key="node2.baseUri" value="${node2.baseUri}"/>

      <batchtest todir="UnitTests">
        <formatter type="xml" />
        <fileset dir="src">
          <include name="**/${JavaClassNamePattern}" />
        </fileset>
      </batchtest>
    </junit>
  </target>
</project>
